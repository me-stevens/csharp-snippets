---
layout:      post
category:    "intro"

title:       "A console file server"
shortitle:   "File Server"
excerpt:     "Listen to changes in a folder."
thumb:       "ex03-thumb.png"
thumb-small: "ex03-thumb-small.png"
---

				<p>In this example we are going to create a basic file server. For this we will actually need two console applications, one acting as a client and the other acting as the server. The client will be started with a parameter <code class="language-csharp">i</code> that will act as its unique identifier: <code class="language-csharp">$ client -i 1</code>.</p>

				<p>The client asks the user to type one of these commands: <code class="language-csharp">S</code>, <code class="language-csharp">H</code> or <code class="language-csharp">L</code>. With this information, the client will generate a "message", that is, a file named <code class="language-csharp">ID_X_00000.txt</code>, where <code class="language-csharp">ID</code> is the unique identifier of the client, <code class="language-csharp">X</code> is the command (<code class="language-csharp">S</code>, <code class="language-csharp">H</code> or <code class="language-csharp">L</code>), and <code class="language-csharp">00000</code> is a counter for the generated files. That file is stored in a predefined folder that can be accessed by the server as well as by all clients</p>

				<p>The server will be listening for a file to appear in that folder. When this happens, it will process the file, breaking down the file name and displaying in the console:</p>

				<ul>
					<li>A square with the ID in the middle, if the command is <code class="language-csharp">S</code>,</li>
					<li>An hexagon with the ID in the middle, if the command is <code class="language-csharp">H</code>,</li>
					<li>A line, but only if the ID equals 1, if the command is <code class="language-csharp">L</code>.</li>
					<li>Any other messages will be discarded.</li>
				</ul>

				<p>When the server is done processing a file, it is deleted from the folder.</p>

				<h2>A possible solution, in C++ first</h2>

				<p>Since C++ is an old cousin of C&#35;, let's do a simple implementation in Linux first, and then we'll go to the example. This solution uses <a href="http://linux.die.net/man/7/inotify">inotify</a>. Prepare for a lot of ASCII art.</p>

				<div class="solution">
					<input type="checkbox" id="show1">
					<label for="show1" class="icon btn yellow">Solution 
{% include arrow-down.svg %}</label>
					<div class="contents">

						<pre class="asciiart"><code>
		         YE OLDE PIRATE' SERVER!


		                 uuuuuuu
		             uu$$$$$$$$$$$uu
		          uu$$$$$$$$$$$$$$$$$uu
		         u$$$$$$$$$$$$$$$$$$$$$u
		        u$$$$$$$$$$$$$$$$$$$$$$$u
		       u$$$$$$$$$$$$$$$$$$$$$$$$$u
		       u$$$$$$$$$$$$$$$$$$$$$$$$$u
		       u$$$$$$"   "$$$"   "$$$$$$u
		       "$$$$"      u$u       $$$$"
		        $$$u       u$u       u$$$
		        $$$u      u$$$u      u$$$
		         "$$$$uu$$$   $$$uu$$$$"
		          "$$$$$$$"   "$$$$$$$"
		            u$$$$$$$u$$$$$$$u
		             u$"$"$"$"$"$"$u
		  uuu        $$u$ $ $ $ $u$$       uuu
		 u$$$$        $$$$$u$u$u$$$       u$$$$
		  $$$$$uu      "$$$$$$$$$"     uu$$$$$$      
		u$$$$$$$$$$$uu    """""    uuuu$$$$$$$$$$
		$$$$"""$$$$$$$$$$uuu   uu$$$$$$$$$"""$$$"
		 """      ""$$$$$$$$$$$uu ""$"""
		           uuuu ""$$$$$$$$$$uuu
		  u$$$uuu$$$$$$$$$uu ""$$$$$$$$$$$uuu$$$
		  $$$$$$$$$$""""           ""$$$$$$$$$$$"
		   "$$$$$"                      ""$$$$""
		     $$$"                         $$$$"

			Arrr! I be watchin' you, ./queue
						</code></pre>

						<p>First, we create a <code class="language-csharp">server.cpp</code> and a <code class="language-csharp">client.cpp</code> programs. Optionally, we could create a <code class="language-csharp">csmanager.cpp</code> too, as we will see later. The files generated by the client are saved in the <code class="language-csharp">queue</code></code> folder, which is in the same directory as the programs.</p>

						<a href="https://github.com/{{ site.git_user }}/{{ site.git_repo }}" class="btn green">
{% include github.svg %} Download the example!</a>

						<h3>The manager program</h3>

						<p>Let's see the list of files we have and explain all of them:</p>

						<pre><code class="language-csharp">
$ tree -L 1 -F --dirsfirst
.
├── queue/
├── client*
├── client.cpp
├── csmanager*
├── csmanager.cpp
├── inotify-cxx.cpp
├── inotify-cxx.h
├── server*
└── server.cpp
1
						</code></pre>

						<p>The three programs can be compiled in Ubuntu (for example), just typing this in the console:</p>

						<pre><code class="language-csharp">
$ g++ csmanager.cpp -o csmanager
$ g++ client.cpp -o client
$ g++ server.cpp inotify-cxx.cpp -o server
						</code></pre>

						<p>To run our server, we can launch the server and the client separately, each in a different console, or we can use the controler, <code class="language-csharp">csmanager.cpp</code>. This program starts the server so that it listens to the <code class="language-csharp">queue</code> folder, and opens another terminal to run the client. The code of <code class="language-csharp">csmanager.cpp</code> is:</p>

						<pre><code class="language-csharp">
/***************************************
* Simple CLI Client-Server Manager
***************************************/
#include &lt;cstdlib>

int main(int argc, char* argv[]) {
	system("gnome-terminal &"); // Client
	system("./server");         // Server
	return 0;
}
						</code></pre>

						<p>To run it, type:</p>

						<pre><code class="language-csharp">
$ ./csmanager
						</code></pre>

						<p>As we said, <code class="language-csharp">csmanager.cpp</code> is optional, we can run the server whenever we want with:</p>

						<pre><code class="language-csharp">
$ ./server
						</code></pre>

						<p>and we can have as many clients as we want to, writing to the same folder, running in another terminal:</p>


						<pre><code class="language-csharp">
$ ./client -i 1
...
$ ./client -i 2
...
						</code></pre>



						<h3>The server program</h3>
						<p>The server program uses a little help from the <code class="language-csharp">inotify-cxx</code> libraries &ndash;<a href="http://inotify.aiken.cz">http://inotify.aiken.cz</a>&ndash; which, at the same time, are a <em>wrapper</em> of <code class="language-csharp">inotify</code> &ndash;<a href="http://linux.die.net/man/7/inotify">http://linux.die.net/man/7/inotify</a>&ndash;. These libraries allow us to use the <code class="language-csharp">inotify</code> functionality in a C++ program. We can use them to "listen" to changes in folders or files in a Linux system.</p>

						<p>To be able to use <code class="language-csharp">inotify-cxx</code>, we should have the <em>headers</em> of <code class="language-csharp">inotify-cxx</code> in our distribution.</p>

						<p>The server program has a group of functions and a <code class="language-csharp">main()</code> method. Once started, it keeps listening until <code class="language-csharp">CTRL + C</code> is pressed.</p>

						<h3>Functions of the server program</h3>

						<dl>
							<dt><code class="language-csharp">string decode(const string& filename, string &id, string &command, string &counter, int digits)</code></dt>
							<dd>Obtains the ID, command and counter from the filename.</dd>

							<dt><code class="language-csharp">void draw()</code></dt>
							<dd>Decides what to draw depending on the file name.</dd>

							<dt><code class="language-csharp">void keelhaul(string directory, string filename)</code></dt>
							<dd>Deletes the file from the server once it is processed.</dd>
						</dl>

						<p>The <code class="language-csharp">main()</code> method implements some of the inotify functions:</p>

						<pre><code class="language-csharp">
/***************************************
 * MAIN
 ***************************************/
int main(int argc, char *argv[]) {
	welcome();

	string directory = "./queue";
	try {
		Inotify notify;

		// Only check for creation and deletion
		InotifyWatch watch(directory, IN_CREATE | IN_DELETE);
		notify.Add(watch);

		// SUPER LEGAL INFINITE LOOP. Exit with CTRL + C
		cout &lt;&lt; "\nArrr! I be watchin' you, " &lt;&lt; directory &lt;&lt; endl &lt;&lt; endl;
		for (;;) {
			notify.WaitForEvents();

			size_t count = notify.GetEventCount();
			while (count > 0) {
				InotifyEvent event;
				bool got_event = notify.GetEvent(&event);

				if (got_event) {
					string eventype;
					event.DumpTypes(eventype);

					string filename = event.GetName();

					cout &lt;&lt; "Avast, "          &lt;&lt; directory &lt;&lt; "!... ";
					cout &lt;&lt; "Me eaye see: \""  &lt;&lt; eventype  &lt;&lt; "\". ";
					cout &lt;&lt; "Ship o' name: \"" &lt;&lt; filename  &lt;&lt; "\"" &lt;&lt; endl &lt;&lt; endl;

					// Here's the parrrty
					if (eventype.compare("IN_CREATE") == 0) {
						draw(filename);
						keelhaul(directory, filename);
					}
				}

				count--;
			}
		}
	} catch (InotifyException &e) {
		cerr &lt;&lt; "Inotify exception occured: " &lt;&lt; e.GetMessage() &lt;&lt; endl;
	} catch (exception &e) {
		cerr &lt;&lt; "STL exception occured: "     &lt;&lt; e.what() &lt;&lt; endl;
	} catch (...) {
		cerr &lt;&lt; "unknown exception occured"   &lt;&lt; endl;
	}

	return 0;
}
						</code></pre>

						<h3>Client program</h3>

						<p>The client program also has a bunch of methods and a <code class="language-csharp">main()</code>. To end the execution, we can write "nope" or "aye" to continue.</p>

						<h3>Functions of the client program</h3>

						<dl>
							<dt><code class="language-csharp">bool check(int argc, char *argv[])</code></dt>
							<dd>Checks the input parameters.</dd>

							<dt><code class="language-csharp">string readCommand(void)</code></dt>
							<dd>Reads a command entered by the user through the console and checks that it is <code class="language-csharp">S</code>, <code class="language-csharp">H</code> or <code class="language-csharp">L</code>.</dd>

							<dt><code class="language-csharp">string getFilename(const string& filename)</code></dt>
							<dd>Strips the filename from the path to the file.</dd>
						</dl>

						<p>And this is the <code class="language-csharp">main()</code> of the client program:</p>
						<pre><code class="language-csharp">
/***************************************
 * MAIN
 * Where all the bad things happen
 ***************************************/
int main(int argc, char *argv[]) {

	if ( !check(argc, argv) ) 
		return 1;

	char * c;
	long i = strtol(argv[2], &c, 10);
	int counter = 0;
	string directory = "./queue";
	string command, filename, answer;

	do {
		command = readCommand();

		// If the ID is not 1 and the command is S, discard message.
		if ( i != 1 && command.compare("S") == 0 )
			cout &lt;&lt; "Swim with the fishes, ye scurvy dog, mwahuahuahaha..." &lt;&lt; endl;

		// Else, create message.
		else {
			// Build filename. If file exists, regenerate (not very elegant, BUT)
			do {
				char counter_str[10];
				sprintf(counter_str, "%05d", counter);

				filename = directory + "/" + argv[2] + "_" + command + "_" + string( counter_str ) + ".txt";

				counter++;
				if(counter > 99999)
					counter = 0;
			} while ( ifstream(filename.c_str()) );
	
			// Now that filename doesn't exist, create file
			ofstream file(filename.c_str());
			if (!file)
				cout &lt;&lt; "Thar be nothin' in the sea! Unable to create ship" &lt;&lt; endl;
			else {
				cout &lt;&lt; "Ship ahoy! It's called '" &lt;&lt; getFilename(filename) &lt;&lt; "'." &lt;&lt; endl;
				file.close();
			}
		}

		cout &lt;&lt; "\nWrite 'aye' to drink moar rum or 'nope' to leave me ship: ";
		cin.clear();
		getline (cin, answer);

	} while(answer.compare("aye") == 0);

	return 0;
}
						</code></pre>

						<p>Go on and launch csmanager in an Ubuntu terminal. Below you will find a screenshot showing all the possible cases!</p>
						
						<img src="{{ site.baseurl }}/img/{{ page.category }}/inotify-screenshot.jpg" width="900" height="712">
						
						<a href="https://github.com/{{ site.git_user }}/{{ site.git_repo }}" class="btn green">
{% include github.svg %} Download the example!</a>
					</div>
				</div>















				<h2>A C&#35; solution</h2>

				<p>How would the previous program be translated into C&#35;? Want to give it a try? See what you can do and then come back to check the example!.</p>

				<div class="solution">
					<input type="checkbox" id="show2">
					<label for="show2" class="icon btn yellow">Example 
{% include arrow-down.svg %}</label>
					<div class="contents">

						<p>In Visual Studio we can not launch two consoles as we did before with the Linux solution, so we have to create two separate programs, <code class="language-csharp">Client</code> and <code class="language-csharp">Server</code>.</p>

						<p>We also can not use inotify anymore, but we can use the <code class="language-csharp">FileSystemWatcher</code> class and <a href="https://msdn.microsoft.com/en-us/library/system.io.filesystemwatcher%28v=vs.110%29.aspx">its methods</a>.</p>

						<p>To launch the client program passing it the arguments as we did in Linux, we have to go to the Solution Explorer, right click on our project name and select <strong>Properties</strong>. Then, go to the <strong>Debug</strong> tab on the left and enter your parameters in the <em>Command Line Arguments</em> textbox. In this case, that would be <code class="language-csharp">client.exe -i 1</code></p>

						<p>To run the programs, you have to open both and run them from the GUI, this will open the two MS-DOS consoles. Just remember to run the server first!</p>

						<p>If after working with the smoother Linux terminal you feel awkward working in MS-DOS, don't worry. We have just one example more to go, and we will be working with Windows Forms. Or you can go to the <a href="{{ site.baseurl }}/">home page</a> and select what you want to learn next =)</p>


						<a href="https://github.com/{{ site.git_user }}/{{ site.git_repo }}" class="btn green">
{% include github.svg %} Download the example!</a>
					</div>
				</div>
